<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SS14 Chem</title>
    <link rel="icon" type="image/png" href="content/webicon.png">
    <style>
        :root {
            --desktop: #008080;
            --surface: #c0c0c0;
            --text: #000000;
            --light-highlight: #FFFFFF;
            --dark-shadow: #808080;
            --bg-input: #FFFFFF;
            --bg-card: #c0c0c0;
            --heat: #d32f2f;
            --cold: #1976d2;
            --link: #0000FF;
        }

        :root.dark {
            --desktop: #000000;
            --surface: #333333;
            --text: #00ff00;
            --light-highlight: #555555;
            --dark-shadow: #000000;
            --bg-input: #111111;
            --bg-card: #222222;
            --heat: #ff5555;
            --cold: #55ffff;
            --link: #00ff00;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--desktop);
            font-family: 'Tahoma', 'Verdana', sans-serif;
            color: var(--text);
            margin: 0; padding: 10px; font-size: 14px;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        .win-out {
            background: var(--surface);
            border-top: 2px solid var(--light-highlight); 
            border-left: 2px solid var(--light-highlight);
            border-right: 2px solid #000; border-bottom: 2px solid #000;
            box-shadow: 1px 1px 0px var(--dark-shadow) inset, -1px -1px 0px #dfdfdf inset;
        }
        .win-in {
            background: var(--bg-input);
            border-top: 2px solid #000; border-left: 2px solid #000;
            border-right: 2px solid var(--light-highlight); 
            border-bottom: 2px solid var(--light-highlight);
            box-shadow: 1px 1px 0px #dfdfdf inset, -1px -1px 0px var(--dark-shadow) inset;
        }

        .main-window { width: 100%; max-width: 1400px; margin: 0 auto; display: flex; flex-direction: column; height: 100%; position: relative; z-index: 10; }
        .title-bar { background: linear-gradient(90deg, #000080, #1084d0); padding: 4px 8px; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .window-content { flex: 1; display: flex; flex-direction: column; padding: 10px; overflow: hidden; }

        .tab-bar { display: flex; padding: 4px 4px 0 4px; gap: 2px; flex-shrink: 0; }
        .tab-btn { padding: 6px 12px; background: var(--surface); border: 2px solid var(--light-highlight); border-right-color:#000; border-bottom:none; border-radius: 4px 4px 0 0; cursor: pointer; font-weight: bold; margin-bottom: -2px; z-index: 1; color: var(--text); }
        .tab-btn.active { border-bottom: 2px solid var(--surface); z-index: 10; padding-bottom: 8px; margin-top: -2px; }

        ::-webkit-scrollbar { width: 16px; height: 16px; background: var(--surface); }
        ::-webkit-scrollbar-thumb { background-color: var(--surface); border: 2px solid var(--light-highlight); border-right-color: #000; border-bottom-color: #000; }
        ::-webkit-scrollbar-track { background: var(--dark-shadow); }

        .split-container { display: flex; flex: 1; gap: 10px; overflow: hidden; margin-top: 10px; min-height: 0; }
        
        .list-pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .props-pane { width: 320px; display: flex; flex-direction: column; border: 2px solid var(--surface); min-height: 0; transition: transform 0.3s ease; }
        .pins-pane { width: 280px; display: flex; flex-direction: column; border: 2px solid var(--surface); min-height: 0; }

        .scroll-area { overflow-y: auto; flex: 1; padding-right: 5px; padding-bottom: 80px; }
        #app { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; padding: 5px; }

        .card { cursor: pointer; border: 1px dotted transparent; background: var(--bg-card); }
        .card:hover { border-color: var(--dark-shadow); }
        .card.selected { background-color: #000080; color: white; }
        .card.selected .section-label, .card.selected .arrow-column { color: white; }
        .card-inner { padding: 6px; }
        .card-header { font-weight: bold; font-size: 12px; margin-bottom: 4px; display: flex; justify-content: space-between; border-bottom: 1px dotted var(--dark-shadow); padding-bottom: 2px; }
        
        input#search { width: 100%; padding: 8px; background: var(--bg-input); color: var(--text); border: none; outline: none; }
        select { background: var(--bg-input); color: var(--text); }

        .sidebar-header { background: navy; color: white; padding: 4px; font-weight: bold; text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .prop-tabs { display: flex; margin-bottom: 4px; }
        .prop-tab { flex: 1; text-align: center; padding: 4px; cursor: pointer; border: 1px solid var(--dark-shadow); background: var(--surface); color: var(--text); }
        .prop-tab.active { background: var(--light-highlight); color: #000; font-weight: bold; border-bottom: none; }
        .prop-content { background: var(--bg-input); padding: 10px; flex: 1; overflow-y: auto; color: var(--text); }
        .prop-pane { display: none; }
        .prop-pane.active { display: block; }
        
        .prop-row { display: flex; margin-bottom: 6px; font-size: 12px; }
        .prop-label { width: 70px; color: #444; flex-shrink: 0; }
        .prop-val { flex: 1; font-weight: bold; word-break: break-word; }

        .pin-card { background: #ffffe0; border: 1px solid #000; margin-bottom: 8px; padding: 5px; box-shadow: 2px 2px 0 #808080; font-size: 11px; position: relative; color: #000; }
        .pin-close { position: absolute; top: 2px; right: 2px; cursor: pointer; color: red; font-weight: bold; border: 1px solid red; width: 14px; height: 14px; text-align: center; line-height: 12px; background: #fff; }

        .meta-tag { background: #eee; color: #000; border: 1px solid #000; padding: 0 4px; font-size: 10px; margin-left: 5px; }
        .reagent-list { list-style: none; padding: 0; margin: 0; font-size: 11px; }
        .reagent-item { display: flex; align-items: center; margin-bottom: 2px; text-transform: capitalize; }
        .beaker-dot { width: 8px; height: 8px; border: 1px solid #000; margin-right: 6px; display: inline-block; background: #fff; }
        
        .footer-bar { margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .player-btn { width: 30px; background: var(--surface); border: 2px solid var(--light-highlight); border-right-color: #000; border-bottom-color: #000; cursor: pointer; color: var(--text); }

        @media (max-width: 900px) {
            .pins-pane { display: none; } 
            .split-container { position: relative; }
            .props-pane {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                z-index: 9999; transform: translateY(100%); transition: transform 0.3s ease;
            }
            .props-pane.open { transform: translateY(0); }
            .mobile-close-btn { display: block !important; margin-bottom: 10px; padding: 10px; background: #d32f2f; color: white; text-align: center; font-weight: bold; cursor: pointer; border: 2px solid #fff; }
        }
        
        .mobile-close-btn { display: none; }
        .view-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .view-content.active { display: flex; }
        .chem-link { color: var(--link); text-decoration: underline; cursor: pointer; font-weight: bold; }
        
        .clown-fall { position: fixed; width: 150px; z-index: 9999; pointer-events: none; top: -200px; animation: fall 4s linear forwards; }
        @keyframes fall { 0% { top: -200px; transform: rotate(0deg); } 100% { top: 120vh; transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="main-window win-out">
        <div class="title-bar">
            <span>SS14 Chemistry Database</span>
            <div onclick="spawnClown()" style="background:#c0c0c0; color:black; width:16px; height:16px; text-align:center; line-height:14px; border:1px solid #fff; border-bottom-color:#000; border-right-color:#000; font-size:12px; cursor:pointer;">X</div>
        </div>

        <div class="window-content">
            <div class="tab-bar">
                <button class="tab-btn active" onclick="switchTab('recipes')">Database</button>
                <button class="tab-btn" onclick="switchTab('guides')">Chemist Shift Guidebook</button>
            </div>

            <div class="win-in" style="flex: 1; display: flex; flex-direction: column; padding: 10px; overflow: hidden;">
                
                <div id="recipe-view" class="view-content active">
                    <input type="text" id="search" class="win-in" placeholder="Search chemicals..." onkeyup="render()" autofocus>
                    
                    <div class="split-container">
                        <div class="list-pane win-in">
                            <div class="scroll-area" id="app">Loading...</div>
                        </div>

                        <div id="prop-sidebar" class="props-pane win-out">
                            <div class="mobile-close-btn" onclick="closeMobileSidebar()">CLOSE DETAILS</div>
                            <div class="sidebar-header">
                                <span>Properties</span>
                                <button id="pin-btn" class="player-btn" style="width: auto; padding: 0 5px;" onclick="pinCurrent()" disabled>PIN</button>
                            </div>
                            <div style="padding: 5px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                <div class="prop-tabs">
                                    <div class="prop-tab active" onclick="switchPropTab('general')">General</div>
                                    <div class="prop-tab" onclick="switchPropTab('recipe')">Recipe</div>
                                    <div class="prop-tab" onclick="switchPropTab('effects')">Effects</div>
                                </div>
                                <div class="prop-content" id="sidebar-content">
                                    <div id="tab-general" class="prop-pane active" style="text-align: center; padding-top: 50px; color: #666;">Select a chemical.</div>
                                    <div id="tab-recipe" class="prop-pane"></div>
                                    <div id="tab-effects" class="prop-pane"></div>
                                </div>
                            </div>
                        </div>

                        <div class="pins-pane win-out">
                            <div class="sidebar-header" style="justify-content: center;">Pinned Items</div>
                            <div id="pin-container" class="win-in scroll-area" style="background: #ccc; padding: 10px;">
                                <div style="color: #666; text-align: center; margin-top: 20px;">No pinned items.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="guide-view" class="view-content">
                    <div style="margin-bottom: 10px;">
                        <select id="guide-filter" class="win-in" onchange="renderGuides()" style="width:100%; padding:4px;">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <div id="guidebook" class="win-in scroll-area" style="background: white; color: black; padding: 10px;">
                        Loading...
                    </div>
                </div>
            </div>
            
            <div class="footer-bar">
                <div class="win-out" style="padding: 2px; display: flex; gap: 2px;">
                    <button class="player-btn" onclick="playMusic()">|&gt;</button>
                    <button class="player-btn" onclick="stopMusic()">[]</button>
                    <span id="track-name" style="background:#000; color:#0f0; font-family:monospace; padding:2px 5px;">READY</span>
                </div>
                <div>
                    <button class="player-btn" style="width: auto; padding: 0 5px;" onclick="toggleTheme()">Theme</button>
                    <span style="font-size: 11px;">v4.0 - honk</span>
                </div>
            </div>
        </div>
    </div>

    <audio id="bgm" loop>
        <source src="content/music.mp3" type="audio/mpeg">
        <source src="content/music.ogg" type="audio/ogg">
    </audio>

<script>
        let recipes = [];
        let guides = [];
        let pinnedItems = [];
        let selectedId = null;
        
        const audio = document.getElementById('bgm');
        const screen = document.getElementById('track-name');

        const chemicalAliases = {
            "Bic": "Bicaridine", "Derma": "Dermaline", "Dylo": "Dylovene",
            "Tri": "Tricordrazine", "Inap": "Inaprovaline", "Dex P": "Dexalin Plus",
            "Dex": "Dexalin", "Pha": "Phalanximine", "Ari": "Arithrazine",
            "Sal": "Saline", "Pun": "Puncturase", "Lac": "Lacerinol",
            "Bru": "Bruizine", "Lepo": "Leporazine", "Pyr": "Pyrotium",
            "Ins": "Insuzine", "Fersi": "Fersilicite", "Dip": "Diphenhydramine",
            "Sig": "Sigynate", "Ocu": "Oculine", "Epi": "Epinephrine",
            "Eth": "Ethylredoxrazine", "Nec": "Necrosol", "Alox": "Aloxadone",
            "Opp": "Opporozidone", "Sid": "Siderlac", "Cryo": "Cryoxadone",
            "Dox": "Clonexadone", "Kelo": "Kelotane", "Trico": "Tricordrazine"
        };

        async function init() {
            const app = document.getElementById('app');
            
            try {
                app.innerHTML = "Fetching chem_recipes.json...";
                const rRes = await fetch('chem_recipes.json');
                
                if (!rRes.ok) {
                    throw new Error(`Recipe File Error: ${rRes.status} ${rRes.statusText} (Check filename casing!)`);
                }
                
                try {
                    recipes = await rRes.json();
                } catch (e) {
                    throw new Error(`Recipe JSON Syntax Error: Your chem_recipes.json file has a typo (comma/quote).`);
                }

                app.innerHTML = "Fetching guides.json...";
                const gRes = await fetch('guides.json');
                
                if (!gRes.ok) {
                    console.warn("guides.json not found, skipping.");
                } else {
                    try {
                        guides = await gRes.json();
                    } catch (e) {
                        console.warn("guides.json syntax error.");
                    }
                }

                render();
                initGuideFilter();
                renderGuides();

            } catch (e) {
                console.error(e);
                app.innerHTML = `
                    <div style="background:red; color:white; padding:20px; font-weight:bold;">
                        CRITICAL ERROR:<br>${e.message}<br><br>
                        1. If running locally, you MUST use a server<br>
                        2. Check Console (F12) for details.
                    </div>`;
            }
        }


        function toggleTheme() { document.documentElement.classList.toggle('dark'); }

        function spawnClown() {
            const honk = new Audio('content/sound_items_bikehorn.ogg');
            honk.volume = 0.5;
            honk.play().catch(e => {});
            const img = document.createElement('img');
            img.src = 'content/clown.webp';
            img.className = 'clown-fall';
            img.style.left = Math.floor(Math.random() * (window.innerWidth - 150)) + 'px';
            document.body.appendChild(img);
            setTimeout(() => { img.remove(); }, 4000);
        }

        function playMusic() { audio.play(); screen.innerText = "TRACK: SPACE ASSHOLE"; }
        function stopMusic() { audio.pause(); audio.currentTime = 0; screen.innerText = "STOPPED"; }

        function switchTab(tab) {
            document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            if (tab === 'recipes') {
                document.getElementById('recipe-view').classList.add('active');
                document.querySelector('button[onclick="switchTab(\'recipes\')"]').classList.add('active');
            } else {
                document.getElementById('guide-view').classList.add('active');
                document.querySelector('button[onclick="switchTab(\'guides\')"]').classList.add('active');
            }
        }

        function switchPropTab(tabName) {
            document.querySelectorAll('.prop-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.prop-pane').forEach(p => p.classList.remove('active'));
            const tabs = ['general', 'recipe', 'effects'];
            document.querySelectorAll('.prop-tab')[tabs.indexOf(tabName)].classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function closeMobileSidebar() { document.getElementById('prop-sidebar').classList.remove('open'); }

        function selectRecipe(chemId) {
            selectedId = chemId;
            document.getElementById('pin-btn').disabled = false;
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            const card = document.getElementById('card-' + chemId);
            if(card) card.classList.add('selected');
            document.getElementById('prop-sidebar').classList.add('open');

            let item = recipes.find(r => r.id === chemId);
            if (!item) item = recipes.find(r => r.products && r.products.some(p => p.id === chemId));
            
            if (!item) return;

            const name = item.name || (item.products ? item.products[0].name : item.id);
            const desc = item.desc || "No description.";
            const color = item.color || "#CCCCCC";
            const id = item.id;

            let genHtml = `
                <div class="prop-row"><div class="prop-label">Name:</div><div class="prop-val">${name}</div></div>
                <div class="prop-row"><div class="prop-label">ID:</div><div class="prop-val" style="font-family:monospace;">${id}</div></div>
                <div class="prop-row"><div class="prop-label">Color:</div><div class="prop-val"><div style="display:inline-block; width:12px; height:12px; background:${color}; border:1px solid #000;"></div> ${color}</div></div>
                <hr>
                <div style="font-style:italic; padding:5px;">${desc}</div>
            `;
            document.getElementById('tab-general').innerHTML = genHtml;

            let reactHtml = '';
            let reactants = item.reactants;
            if(!reactants && item.recipes && item.recipes.length > 0) reactants = item.recipes[0].reactants; 

            if (reactants && reactants.length > 0) {
                reactHtml = `<div style="margin-bottom:5px;"><b>Ingredients:</b></div><ul style="padding-left:20px; margin:0;">`;
                reactants.forEach(r => {
                    let rName = r.name || r.id;
                    const exists = recipes.some(rec => rec.id === r.id || rec.name === rName);
                    let display = exists ? `<span class="chem-link" onclick="goToRecipe('${rName}')">${rName}</span>` : rName;
                    reactHtml += `<li>${r.amount}u ${display}</li>`;
                });
                reactHtml += `</ul>`;
                
                if(item.conditions || (item.recipes && item.recipes[0].conditions)) {
                    let conds = item.conditions || item.recipes[0].conditions;
                    if (conds.minTemp || conds.maxTemp) {
                        reactHtml += `<hr><div style="margin-bottom:5px;"><b>Conditions:</b></div>`;
                        if(conds.minTemp) reactHtml += `<div>Min Temp: <span style="color:var(--heat)">${Math.round(conds.minTemp)}K</span></div>`;
                        if(conds.maxTemp) reactHtml += `<div>Max Temp: <span style="color:var(--cold)">${Math.round(conds.maxTemp)}K</span></div>`;
                    }
                }
            } else {
                reactHtml = "<div style='color:#666; font-style:italic;'>No known recipe.</div>";
            }
            document.getElementById('tab-recipe').innerHTML = reactHtml;

            let effHtml = '';
            if (item.overdose) effHtml += `<div class="prop-row"><div class="prop-label" style="color:red; font-weight:bold;">Overdose:</div><div class="prop-val">${item.overdose}u</div></div><hr>`;
            
            let effects = item.effects || item.meta_stats; 
            
            if (effects && effects.length > 0) {
                effHtml += `<div><b>Effects:</b></div><ul style="padding-left:20px;">`;
                effects.forEach(e => {
                    if (typeof e === 'string') {
                        effHtml += `<li>${e}</li>`;
                    } else if (e.effects) {
                        e.effects.forEach(sub => effHtml += `<li>${sub}</li>`);
                    }
                });
                effHtml += `</ul>`;
            } else {
                if(!item.overdose) effHtml = "<div style='color:#666; font-style:italic;'>No known effects.</div>";
            }
            document.getElementById('tab-effects').innerHTML = effHtml;
        }

        function pinCurrent() {
            if(!selectedId) return;
            if(pinnedItems.includes(selectedId)) return;
            pinnedItems.push(selectedId);
            renderPins();
        }

        function removePin(id) {
            pinnedItems = pinnedItems.filter(p => p !== id);
            renderPins();
        }

        function renderPins() {
            const container = document.getElementById('pin-container');
            if(pinnedItems.length === 0) {
                container.innerHTML = `<div style="color: #666; text-align: center; margin-top: 20px;">No pinned items.</div>`;
                return;
            }
            container.innerHTML = pinnedItems.map(id => {
                let item = recipes.find(r => r.id === id);
                if (!item) return '';
                const name = item.name || item.id;
                
                let ingredients = '';
                let reactants = item.reactants;
                if(!reactants && item.recipes && item.recipes.length > 0) reactants = item.recipes[0].reactants; 
                
                if (reactants) {
                    reactants.forEach(r => ingredients += `<div>- ${r.amount}u ${r.name || r.id}</div>`);
                } else {
                    ingredients = "<div>No recipe</div>";
                }
                
                return `
                <div class="pin-card">
                    <div class="pin-close" onclick="removePin('${id}')">X</div>
                    <div style="font-weight:bold; border-bottom:1px solid #aaa; margin-bottom:4px; cursor:pointer;" onclick="selectRecipe('${id}')">${name}</div>
                    <div style="font-size:10px;">${ingredients}</div>
                </div>`;
            }).join('');
        }

        function goToRecipe(chemName) {
            switchTab('recipes');
            document.getElementById('search').value = chemName;
            render();
            const match = recipes.find(r => (r.name || r.id).toLowerCase() === chemName.toLowerCase());
            if (match) selectRecipe(match.id);
        }

        function linkify(text) {
            const keys = Object.keys(chemicalAliases).sort((a, b) => b.length - a.length);
            let linkedText = text;
            keys.forEach(alias => {
                const fullName = chemicalAliases[alias];
                const regex = new RegExp(`\\b${alias}\\b`, 'g');
                linkedText = linkedText.replace(regex, `<span class="chem-link" onclick="goToRecipe('${fullName}')">${alias}</span>`);
            });
            return linkedText;
        }

        function initGuideFilter() {
            const select = document.getElementById('guide-filter');
            if(!select || !guides.length) return;
            select.innerHTML = '<option value="all">All Categories</option>';
            guides.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.category;
                opt.innerText = cat.category;
                select.appendChild(opt);
            });
        }

        function renderGuides() {
            const filterVal = document.getElementById('guide-filter').value;
            const container = document.getElementById('guidebook');
            const filtered = (filterVal === 'all') ? guides : guides.filter(cat => cat.category === filterVal);
            container.innerHTML = filtered.map(cat => `
                <div class="guide-category">
                    <div style="font-weight:bold; border-bottom:2px solid #000; margin-bottom:5px;">${cat.category}</div>
                    ${cat.guides.map(g => `
                        <div class="guide-entry" style="color:black;">
                            <div class="guide-title">${linkify(g.title)}</div>
                            ${g.content.map(step => `<div style="margin-bottom:2px; padding-left:10px;">${linkify(step)}</div>`).join('')}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function render() {
            const query = document.getElementById('search').value.toLowerCase();
            const container = document.getElementById('app');
            const filtered = recipes.filter(r => 
                (r.name && r.name.toLowerCase().includes(query)) || 
                (r.id && r.id.toLowerCase().includes(query))
            );
            
            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:20px;">No matches found.</div>`;
                return;
            }
            container.innerHTML = filtered.map(r => {
                const name = r.name || r.id;
                const isSelected = (selectedId === r.id) ? 'selected' : '';
                
                let mixHtml = '';
                let reactants = r.reactants;
                if(!reactants && r.recipes && r.recipes.length > 0) reactants = r.recipes[0].reactants;
                if(reactants) {
                    mixHtml = `<ul class="reagent-list">${reactants.slice(0,3).map(i => `<li><div class="beaker-dot" style="background:white;"></div>${i.amount}u ${i.name||i.id}</li>`).join('')}</ul>`;
                }

                return `
                <div id="card-${r.id}" class="card win-out ${isSelected}" onclick="selectRecipe('${r.id}')">
                    <div class="card-inner">
                        <div class="card-header">
                            <span class="name-text">${name}</span>
                        </div>
                        <div style="font-size:11px; color:#444;" class="recipe-desc">${r.desc ? r.desc.substring(0, 50) + '...' : ''}</div>
                        ${mixHtml}
                    </div>
                </div>`;
            }).join('');
        }

        init();
    </script>
</body>
</html>